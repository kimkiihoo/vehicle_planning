# 非结构道路车辆轨迹规划与泊车 Demo

基于 **混合A\*（Hybrid A\*）** 算法结合 **Reeds-Shepp 曲线**，实现非结构化道路环境下的车辆全局轨迹规划与自动泊车（倒车入库）。

## 项目结构

```
planning_ws/
├── input/                          # 输入配置
│   ├── map.json                    # 地图边界与分辨率
│   ├── obstacles.json              # 障碍物定义（多边形）
│   └── scenario.json               # 起点、终点、停车位配置
├── planner/                        # 规划器核心模块
│   ├── __init__.py                 # 包初始化
│   ├── hybrid_a_star.py            # 混合A*主算法
│   ├── collision_lookup.py         # 碰撞检测（栅格 + 车辆几何）
│   └── reeds_shepp_path_planning.py  # Reeds-Shepp曲线生成
├── output/                         # 输出结果
│   ├── output.json                 # 轨迹数据（坐标、航向、方向、曲率）
│   ├── output.jpg                  # 静态规划结果图
│   └── output.gif                  # 规划过程动画
├── run_demo.py                     # 主入口脚本
├── requirements.txt                # Python 依赖
└── venv/                           # Python 虚拟环境
```

## 环境安装

### 1. 系统要求

- **操作系统**: Ubuntu 20.04 / 22.04 / 24.04
- **Python**: 3.10+
- **中文字体**: Noto Sans CJK SC（系统通常已预装）

安装字体（如未安装）：

```bash
sudo apt install fonts-noto-cjk
```

### 2. 创建虚拟环境并安装依赖

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

`requirements.txt` 中的依赖包括：

| 包名 | 用途 |
|------|------|
| `numpy` | 数值计算、栅格地图操作 |
| `matplotlib` | 可视化绘图 |
| `shapely` | 多边形障碍物几何运算与光栅化 |
| `imageio` | GIF 动画生成 |
| `heapdict` | 优先队列（A\*搜索使用） |

## 启动方式

```bash
# 使用虚拟环境运行
./venv/bin/python run_demo.py
```

运行完成后，结果将保存至 `output/` 目录：

| 输出文件 | 说明 |
|---------|------|
| `output.json` | 完整轨迹数据，包含每个点的坐标、航向角、行驶方向（前进/倒车）、曲率 |
| `output.jpg` | 静态规划结果图，展示地图、障碍物、停车位和规划轨迹 |
| `output.gif` | 车辆沿轨迹运动的动画，包含实时方向提示和进度显示 |

## 场景自定义

通过修改 `input/` 目录下的 JSON 文件可以自定义场景：

### `map.json` — 地图参数

```json
{
    "x_min": 0.0, "y_min": 0.0,
    "x_max": 80.0, "y_max": 50.0,
    "resolution": 0.1
}
```

### `obstacles.json` — 障碍物定义

每个障碍物为一组多边形顶点：

```json
{
    "obstacles": [
        {
            "type": "polygon",
            "vertices": [[x1,y1], [x2,y2], [x3,y3], [x4,y4]],
            "label": "障碍物名称"
        }
    ]
}
```

### `scenario.json` — 起终点与停车位

```json
{
    "start": {"x": 5.0, "y": 25.0, "yaw_deg": 0.0},
    "goal":  {"x": 60.0, "y": 42.0, "yaw_deg": -90.0},
    "parking_slot": {
        "center": [60.0, 42.0],
        "size": [7.0, 11.0],
        "heading_deg": 90.0,
        "type": "垂直车位（三面围栏，倒车入库）"
    }
}
```

> **注意**: `goal.yaw_deg` 设为 `-90°` 表示车头朝下停放，此时从开口侧（下方）进入需要倒车入库。

## 基本原理

### 整体流程

```
JSON输入 → 栅格地图构建 → 碰撞检测初始化 → 混合A*搜索 → Reeds-Shepp连接 → 轨迹输出
```

### 1. 栅格地图构建

将 JSON 中定义的多边形障碍物通过 Shapely 几何库光栅化到二值栅格地图（0=障碍，1=空闲）。分辨率默认为 0.1 米/格。

### 2. 混合A\*搜索

与传统 A\* 不同，混合 A\* 在搜索中考虑车辆的运动学约束：

- **状态空间**: $(x, y, \theta)$，其中 $\theta$ 为航向角  
- **运动模型**: 自行车模型（前轮转向），支持前进和倒车  
- **离散化**: 位置按 `xy_resolution` 离散，航向按 `yaw_resolution` 离散  
- **启发函数**: Dijkstra 距离场 + 障碍物代价场  

代价函数包含以下部分：

| 代价项 | 说明 | 权重 |
|-------|------|------|
| 路径长度 | 行驶距离 | 1.0 |
| 倒车惩罚 | 减少不必要的倒车 | 100.0 |
| 方向切换惩罚 | 减少前进/倒车切换次数 | 25.0 |
| 转向角惩罚 | 偏好直线行驶 | 25.0 |
| 转向角变化惩罚 | 平滑转向 | 10.0 |
| 障碍物接近代价 | 远离障碍物 | 20.0 |

### 3. Reeds-Shepp 曲线连接

当搜索节点距目标足够近时（默认 50 米），尝试使用 Reeds-Shepp 曲线直接连接到目标。Reeds-Shepp 曲线是满足最小转弯半径约束的最短路径，由圆弧和直线段组合而成，支持前进和倒车，是泊车场景的关键。

### 4. 碰撞检测

采用两级碰撞检测策略：

1. **快速轮廓检测**: 检查车辆四角和前后边线采样点  
2. **精确栅格检测**: 对车辆占据区域内的所有障碍栅格做矩形包含测试（NumPy 向量化加速）

### 5. 车辆参数

| 参数 | 值 | 说明 |
|------|------|------|
| 轴距 (WB) | 3.5 m | 前后轴距离 |
| 车宽 (W) | 3.2 m | 车辆宽度 |
| 前悬 (LF) | 4.51 m | 后轴到车头 |
| 后悬 (LB) | 1.01 m | 后轴到车尾 |
| 最大转向角 | 34° | 前轮最大偏转角 |

## 示例输出

当前默认场景为一个 80m × 50m 的非结构化道路区域，包含碎石堆、施工区域、植被、停放车辆等障碍物。目标是一个三面围栏的垂直车位，车辆需要从起点出发，绕过障碍物，最终倒车入库。

运行结果：
- 混合A\*迭代 264 次
- 搜索用时约 8.6 秒
- 规划轨迹包含 176 个点（127 个前进 + 49 个倒车）
- 最终阶段车辆倒车进入三面围栏车位
